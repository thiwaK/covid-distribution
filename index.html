<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Covid Disribution</title>
    <link rel="stylesheet" href="src/css/global.css" />
    <link rel="stylesheet" href="src/css/leaflet.css" />
    <link rel="stylesheet" href="src/css/leaflet-search.css" />
    <!-- <link rel="stylesheet" href="src/css/leaflet-search.mobile.css" /> -->

    <link rel="stylesheet" href="covid-distribution/src/css/global.css" />
    <link rel="stylesheet" href="covid-distribution/src/css/leaflet.css" />
    <link rel="stylesheet" href="covid-distribution/src/css/leaflet-search.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
    <!-- <link rel="stylesheet" href="covid-distribution/src/css/leaflet-search.mobile.css" /> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->
    <style>
      .chart-container {
        height: 245px;
        width: 245px;
      }
    
      #info-pane {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 400;
        padding: 1em;
        background: white;
      }
    </style>
  </head>

  <body>

    <div id="map"></div>

    <div id="info-pane" class="leaflet-bar chart-container">
      <canvas id="chartCanvas"></canvas>
    </div>

    <script src="src/js/leaflet.js" ></script>
    <script src="src/js/leaflet-search.js"></script>
    <script src="src/js/heatmap.js"></script>
    <!-- <script src="src/js/leaflet-heat.js"></script> -->
    <script src="src/js/heatmap-overlay.js"></script>
    <script src="src/js/script.js"></script>

    <script src="covid-distribution/src/js/leaflet.js" ></script>
    <script src="covid-distribution/src/js/leaflet-search.js"></script>
    <script src="covid-distribution/src/js/heatmap.js"></script>
    <script src="covid-distribution/src/js/heatmap-overlay.js"></script>
    
    <script src="covid-distribution/src/js/script.js"></script>
   

    <script>
     
      // STEP 2: DEFINE A CHART
      // this is a static scatterplot chart definition for now, but it will
      // soon become dynamic by responding to map and feature layer events
      var initialChartData = {
        datasets: [{
          label: 'Portland Heritage Trees',
          // the data values are empty at this moment
          // and will be updated dynamically below
          data: []
        }]
      };
    
      var chartOptions = {
        scales: {
          xAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'tree diameter'
            },
            ticks: {
              beginAtZero: true,
              max: 250,
              stepSize: 50
            }
          }],
          yAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'tree height'
            },
            ticks: {
              beginAtZero: true,
              max: 250,
              stepSize: 50
            }
          }]
        },
        maintainAspectRatio: false,
        // turn off animations during chart data updates
        animation: {
          duration: 0
        },
        // see STEP 4 below
        onHover: handleChartHover
      };
    
      var chart = new Chart('chartCanvas', {
        type: 'scatter',
        data: initialChartData,
        options: chartOptions
      });
    
      // STEP 3: MAKE THE CHART DYNAMIC BY ESTABLISHING MAP-TO-CHART COMMUNICATION
      // show in the scatterplot only the features in the map's current extent
      // by handling several events from both the map and feature layer
      map.on('zoom move', updateChart);
      treesFeatureLayer.on('load', updateChart);
    
      function updateChart () {
        // reformat the features' attributes of interest into
        // the data array format required by the Chart.js scatterplot
        var scatterPlotDataArray = [];
    
        treesFeatureLayer.eachActiveFeature(function (e) {
          // loop over each active feature in the map extent and
          // push an object into the scatterPlotDataArray in this format:
    
          // {
          //   x: diameter attribute value,
          //   y: height attribute value,
          //   featureId: unique ID for chart-to-map communication in STEP 4
          // }
    
          scatterPlotDataArray.push({
            x: e.feature.properties.DIAMETER,
            y: e.feature.properties.HEIGHT,
            featureId: e.feature.id
          });
        });
    
        // assign the new scatterPlotDataArray to the chart's data property
        chart.data.datasets[0].data = scatterPlotDataArray;
    
        // finally, instruct the chart to re-draw itself with the new data
        chart.update();
      }
    
      // STEP 4 (OPTIONAL): ESTABLISH CHART-TO-MAP COMMUNICATION
      // up until now the map and feature layer inform the chart what to render,
      // but interactions with the chart can also influence the map contents
      function handleChartHover (e) {
        var chartHoverData = chart.getElementsAtEvent(e);
    
        if (!chartHoverData.length) {
          // if there were no data elements found when hovering over the chart,
          // reset any previous styling overrides and return
          treesFeatureLayer.eachFeature(function (e) {
            e.setOpacity(1);
            e.setZIndexOffset(0);
          });
    
          return;
        }
    
        // otherwise, bring attention to the features on the map
        // that are currently being hovered over in the chart
        var hoverFeatureIds = chartHoverData.map(function (datum) {
          return chart.data.datasets[0].data[datum._index].featureId;
        });
    
        treesFeatureLayer.eachFeature(function (e, idx) {
          if (
            hoverFeatureIds.indexOf(e.feature.id) > -1
          ) {
            e.setOpacity(1);
            e.setZIndexOffset(10000);
          } else {
            e.setOpacity(0.1);
          }
        });
      }
    </script>
 
  </body>
</html>